name: Automated Electron App Release
run-name: >-
  YakShaver Build #${{ github.run_number }} 

on:
  push:
    branches:
      - main

permissions:
  actions: write
  contents: write
  pull-requests: write

env:
  NODE_VERSION: 20

jobs:
  auto-release:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      tag_name: ${{ steps.get_version.outputs.tag_name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set run name to PR title
        id: set_run_name
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Try to extract PR number from squash-merge commit message
          PR_NUMBER=$(git log -1 --pretty=%B | head -1 | grep -oE '\(#[0-9]+\)' | grep -oE '[0-9]+' || echo "")

          # Fallback: use gh to find PR by commit SHA
          if [ -z "$PR_NUMBER" ]; then
            PR_NUMBER=$(gh pr list --search "${{ github.sha }}" --state merged --json number --jq '.[0].number' 2>/dev/null || echo "")
          fi

          # Get PR title if we have a PR number
          if [ -n "$PR_NUMBER" ]; then
            PR_TITLE=$(gh pr view "$PR_NUMBER" --json title --jq '.title' 2>/dev/null || echo "")
          else
            # As a last resort, strip the " (#NNN)" suffix from the commit message
            PR_TITLE=$(git log -1 --pretty=%B | sed -E 's/ *\(#[0-9]+\)//' | head -1)
          fi

          if [ -n "$PR_TITLE" ]; then
            echo "Setting run name to: $PR_TITLE"
            curl -s -X PATCH \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              -H "Content-Type: application/json" \
              https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.run_id }} \
              -d "$(printf '{"name":"%s"}' "$PR_TITLE")"
          else
            echo "PR title not found; leaving run name as-is."
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Update Display Name
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1. èŽ·å–ç¬¬ä¸€è¡Œæ¶ˆæ¯
          MSG=$(echo "${{ github.event.head_commit.message }}" | head -n 1)
          # 2. å¦‚æžœæ˜¯ PR åˆå¹¶ï¼ŒåŽ»æŽ‰æœ«å°¾çš„ (#123)
          CLEAN_TITLE=$(echo "$MSG" | sed 's/ (#.*//')
          # 3. è°ƒç”¨ GitHub API ä¿®æ”¹å½“å‰è¿è¡Œçš„æ˜¾ç¤ºæ ‡é¢˜
          gh api -X PATCH /repos/${{ github.repository }}/actions/runs/${{ github.run_id }} \
            -f "display_title=ðŸš€ Build #${{ github.run_number }}: $CLEAN_TITLE"

      - name: Generate version
        id: get_version
        run: |
          # Generate version: YYYY.M.D-BUILD.RUN_NUMBER.SHORT_SHA
          YEAR=$(date +'%Y')
          MONTH=$(date +'%-m')   # Remove leading zero
          DAY=$(date +'%-d')     # Remove leading zero
          RUN_NUMBER=${{ github.run_number }}
          SHORT_SHA=$(git rev-parse --short HEAD)

          VERSION="${YEAR}.${MONTH}.${DAY}-BUILD.${RUN_NUMBER}.${SHORT_SHA}"

          echo "Generated version: $VERSION"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag_name=${VERSION}" >> $GITHUB_OUTPUT

      - name: Create and publish GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME="${{ steps.get_version.outputs.tag_name }}"
          VERSION="${{ steps.get_version.outputs.version }}"

          gh release create "$TAG_NAME" \
            --title "$VERSION" \
            --generate-notes \
            --target main \
            --draft=false

          echo "Release created and published"

      - name: Extract PR number from commit
        id: pr_number
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Extract PR number from squash merge format: "title (#123)"
          PR_NUMBER=$(git log -1 --pretty=%B | head -1 | grep -oE '\(#[0-9]+\)' | grep -oE '[0-9]+' || echo "")

          # Fallback: use GitHub API to find PR by commit SHA
          if [ -z "$PR_NUMBER" ]; then
            PR_NUMBER=$(gh pr list --search "${{ github.sha }}" --state merged --json number --jq '.[0].number' 2>/dev/null || echo "")
          fi

          echo "pr_number=${PR_NUMBER}" >> $GITHUB_OUTPUT
          echo "Found PR number: ${PR_NUMBER}"

      - name: Comment on PR
        uses: peter-evans/create-or-update-comment@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ steps.pr_number.outputs.pr_number }}
          body: |
            âœ… **Automated Release Created Successfully**

            **Release Details:**
            - **Version:** ${{ steps.get_version.outputs.version }}
            - **Tag:** ${{ steps.get_version.outputs.tag_name }}
            - **Release:** https://github.com/${{ github.repository }}/releases/tag/${{ steps.get_version.outputs.tag_name }}

            You can monitor the build progress in the [Actions tab](https://github.com/${{ github.repository }}/actions/workflows/automated-release-electron-app.yml).
